# 以太网协议报文格式详解

## 1. IPv4协议报文格式

以太网中IPv4协议的报文格式如下：

### IPv4报文头部格式（20-60字节）

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|Version|  IHL  |Type of Service|          Total Length         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|         Identification        |Flags|      Fragment Offset    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Time to Live |    Protocol   |         Header Checksum       |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                       Source Address                          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Destination Address                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Options                    |    Padding    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

### 各字段详细说明：

**版本号(Version) - 4位**
- 标识IP协议版本，IPv4为0100

**首部长度(IHL) - 4位**
- IP首部长度，以4字节为单位，最小值为5（20字节）

**服务类型(Type of Service) - 8位**
- 指定数据报的服务质量，包括优先级、延迟、吞吐量、可靠性等

**总长度(Total Length) - 16位**
- 整个IP数据报的长度（首部+数据），以字节为单位，最大65535字节

**标识符(Identification) - 16位**
- 唯一标识一个数据报，用于分片重组

**标志位(Flags) - 3位**
- DF(Don't Fragment): 不分片标志
- MF(More Fragment): 更多分片标志
- 保留位: 必须为0

**片偏移(Fragment Offset) - 13位**
- 分片在原数据报中的位置，以8字节为单位

**生存时间(TTL) - 8位**
- 数据报在网络中的最大跳数，防止无限循环

**协议(Protocol) - 8位**
- 指示上层协议类型（如TCP=6, UDP=17, ICMP=1）

**首部校验和(Header Checksum) - 16位**
- 仅对IP首部进行校验

**源IP地址(Source Address) - 32位**
- 发送方的IP地址

**目的IP地址(Destination Address) - 32位**
- 接收方的IP地址

**选项(Options) - 0-40字节**
- 可选字段，长度可变

**填充(Padding)**
- 确保首部长度为4字节的倍数

### 在以太网帧中的位置：

```
[以太网首部][IPv4首部][上层协议数据][以太网尾部]
```

IPv4报文作为以太网帧的载荷部分，承载在以太网帧的数据字段中。

## 2. IPv6协议报文格式

以太网中IPv6协议的报文格式如下：

### IPv6报文头部格式（固定40字节）

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|Version| Traffic Class |           Flow Label                  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|         Payload Length        |  Next Header  |   Hop Limit   |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
+                                                               +
|                                                               |
+                         Source Address                        +
|                                                               |
+                                                               +
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
+                                                               +
|                                                               |
+                      Destination Address                      +
|                                                               |
+                                                               +
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

### 各字段详细说明：

**版本号(Version) - 4位**
- 标识IP协议版本，IPv6为0110(6)

**流量类别(Traffic Class) - 8位**
- 类似IPv4的服务类型字段，用于QoS分类和拥塞控制
- 前6位用于DSCP（差分服务代码点）
- 后2位用于ECN（显式拥塞通知）

**流标签(Flow Label) - 20位**
- 标识属于同一流的数据包，用于流量工程和QoS处理
- 相同流的数据包具有相同的流标签

**载荷长度(Payload Length) - 16位**
- 载荷部分长度（不包括IPv6基本头部），以字节为单位
- 最大值65535字节，对于更大数据需要使用扩展头部

**下一个头部(Next Header) - 8位**
- 指示紧跟在IPv6头部后面的头部类型
- 可以是上层协议头部（TCP=6, UDP=17, ICMPv6=58）
- 也可以是IPv6扩展头部

**跳数限制(Hop Limit) - 8位**
- 类似IPv4的TTL，数据包在网络中的最大跳数
- 每经过一个路由器减1，减至0时丢弃

**源地址(Source Address) - 128位**
- 发送方的IPv6地址（16字节）

**目的地址(Destination Address) - 128位**
- 接收方的IPv6地址（16字节）

### IPv6扩展头部（可选）

IPv6可以包含多个扩展头部，按特定顺序排列：

```
[IPv6基本头部][扩展头部1][扩展头部2]...[上层协议头部][数据]
```

常见扩展头部类型：
- **逐跳选项头部(Hop-by-Hop Options)** - 0
- **路由头部(Routing Header)** - 43
- **分片头部(Fragment Header)** - 44
- **认证头部(Authentication Header)** - 51
- **封装安全载荷头部(ESP Header)** - 50
- **目的选项头部(Destination Options)** - 60

### 在以太网帧中的位置：

```
[以太网首部][IPv6头部][扩展头部(可选)][上层协议数据][以太网尾部]
```

### IPv6与IPv4的主要区别：

1. **地址长度**: 128位 vs 32位
2. **头部长度**: 固定40字节 vs 可变20-60字节
3. **校验和**: 无头部校验和（由链路层和传输层负责）
4. **分片**: 仅在源端分片，中间路由器不分片
5. **选项处理**: 使用扩展头部链，更灵活高效
6. **自动配置**: 支持无状态地址自动配置
7. **内置安全**: IPSec是IPv6的必需组件

## 3. TCP协议报文格式

以太网中TCP协议的报文格式如下：

### TCP报文头部格式（20-60字节）

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|          Source Port          |       Destination Port       |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        Sequence Number                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Acknowledgment Number                      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Data |           |U|A|P|R|S|F|                               |
| Offset| Reserved  |R|C|S|S|Y|I|            Window             |
|       |           |G|K|H|T|N|N|                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|           Checksum            |         Urgent Pointer        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Options                    |    Padding    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                             data                              |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

### 各字段详细说明：

**源端口(Source Port) - 16位**
- 发送方应用程序的端口号（0-65535）

**目的端口(Destination Port) - 16位**
- 接收方应用程序的端口号（0-65535）

**序列号(Sequence Number) - 32位**
- 本报文段所发送数据的第一个字节在整个字节流中的序号
- 用于数据排序和重复检测

**确认号(Acknowledgment Number) - 32位**
- 期望收到下一个报文段的第一个数据字节的序号
- 仅在ACK标志位为1时有效

**数据偏移(Data Offset) - 4位**
- TCP头部长度，以4字节为单位，最小值为5（20字节）

**保留字段(Reserved) - 6位**
- 保留为0，供将来使用

**控制标志位(Control Flags) - 6位**
- **URG**: 紧急指针有效
- **ACK**: 确认号有效
- **PSH**: 推送数据（尽快交付给应用层）
- **RST**: 重置连接
- **SYN**: 同步序列号（建立连接）
- **FIN**: 发送方数据发送完毕（关闭连接）

**窗口大小(Window) - 16位**
- 接收方愿意接收的字节数，用于流量控制
- 表示从确认号开始还能接收多少字节

**校验和(Checksum) - 16位**
- 对TCP头部、数据和伪头部的校验和
- 伪头部包括源IP、目的IP、协议号和TCP长度

**紧急指针(Urgent Pointer) - 16位**
- 指向紧急数据的最后一个字节
- 仅在URG标志位为1时有效

**选项(Options) - 0-40字节**
- 可选字段，长度可变
- 常见选项：最大报文段长度(MSS)、窗口扩大、时间戳等

**填充(Padding)**
- 确保TCP头部长度为4字节的倍数

### 在以太网帧中的完整结构：

```
[以太网头部][IP头部][TCP头部][应用数据][以太网尾部]
```

具体层次结构：
```
+-----------------+
| 以太网头部(14字节) |
+-----------------+
| IP头部(20-60字节) |
+-----------------+
| TCP头部(20-60字节)|
+-----------------+
|    应用数据      |
+-----------------+
| 以太网尾部(4字节) |
+-----------------+
```

### TCP伪头部（用于校验和计算）

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                       Source Address                          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Destination Address                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|      Zero     |    Protocol   |        TCP Length             |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

### 常见TCP选项格式：

**最大报文段长度(MSS) - 4字节**
```
| Kind=2 | Length=4 |    MSS Value (16位)    |
```

**窗口扩大因子 - 3字节**
```
| Kind=3 | Length=3 | Shift Count |
```

**时间戳选项 - 10字节**
```
| Kind=8 | Length=10 | Timestamp Value | Timestamp Echo Reply |
```

TCP协议通过这种报文格式实现可靠的、面向连接的数据传输，提供流量控制、拥塞控制和错误检测等功能。

## 4. UDP协议报文格式

以太网中UDP协议的报文格式如下：

### UDP报文头部格式（固定8字节）

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|          Source Port          |       Destination Port       |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|            Length             |           Checksum            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                             Data                              |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

### 各字段详细说明：

**源端口(Source Port) - 16位**
- 发送方应用程序的端口号（0-65535）
- 如果不需要回复，可以设置为0

**目的端口(Destination Port) - 16位**
- 接收方应用程序的端口号（0-65535）
- 用于标识目标应用程序

**长度(Length) - 16位**
- UDP头部和数据的总长度，以字节为单位
- 最小值为8（仅头部），最大值为65535
- 长度 = UDP头部(8字节) + 数据长度

**校验和(Checksum) - 16位**
- 对UDP头部、数据和伪头部的校验和
- 在IPv4中是可选的（可以为0），在IPv6中是必需的
- 如果计算结果为0，则填入全1（0xFFFF）

**数据(Data) - 可变长度**
- 应用层数据
- 最大长度为65535-8=65527字节

### 在以太网帧中的完整结构：

```
[以太网头部][IP头部][UDP头部][应用数据][以太网尾部]
```

具体层次结构：
```
+-----------------+
| 以太网头部(14字节) |
+-----------------+
| IP头部(20-60字节) |
+-----------------+
| UDP头部(8字节)   |
+-----------------+
|    应用数据      |
+-----------------+
| 以太网尾部(4字节) |
+-----------------+
```

### UDP伪头部（用于校验和计算）

#### IPv4伪头部：
```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                       Source Address                          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Destination Address                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|      Zero     |    Protocol   |         UDP Length            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

#### IPv6伪头部：
```
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
+                         Source Address                        +
|                           (128 bits)                         |
+                                                               +
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
+                      Destination Address                      +
|                           (128 bits)                         |
+                                                               +
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        UDP Length                             |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Zero                   |  Next Header=17   |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

### UDP协议特点：

**优点：**
- **简单高效**: 头部开销小，处理速度快
- **无连接**: 不需要建立和维护连接状态
- **实时性好**: 没有重传和流量控制机制
- **支持广播/组播**: 可以一对多通信

**缺点：**
- **不可靠**: 不保证数据包到达、顺序或完整性
- **无流量控制**: 不能根据接收方能力调整发送速率
- **无拥塞控制**: 可能加剧网络拥塞

### 常见UDP应用：

- **DNS查询** (端口53)
- **DHCP** (端口67/68)
- **SNMP** (端口161)
- **NTP时间同步** (端口123)
- **实时音视频传输** (RTP/RTCP)
- **在线游戏**
- **流媒体服务**

### UDP与TCP的主要区别：

| 特性 | UDP | TCP |
|------|-----|-----|
| 连接性 | 无连接 | 面向连接 |
| 可靠性 | 不可靠 | 可靠 |
| 头部大小 | 8字节 | 20-60字节 |
| 传输速度 | 快 | 相对较慢 |
| 应用场景 | 实时应用 | 可靠传输 |

UDP协议因其简单高效的特性，非常适合对实时性要求高但对可靠性要求相对较低的应用场景。

## 5. 汽车以太网SOME/IP协议报文格式

汽车以太网中SOME/IP协议的报文格式如下：

### SOME/IP报文头部格式（16字节）

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                          Service ID                           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                          Method ID                            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                            Length                             |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                          Client ID                            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                          Session ID                           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Protocol Ver |Interface Ver  |   Message Type    |Return Code|
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                          Payload                              |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

### 各字段详细说明：

**服务ID(Service ID) - 32位**
- 唯一标识一个服务实例
- 高16位：服务标识符
- 低16位：实例标识符

**方法ID(Method ID) - 32位**
- 标识服务中的具体方法、事件或字段
- 对于方法调用：方法标识符
- 对于事件：事件标识符
- 对于字段：字段标识符

**长度(Length) - 32位**
- SOME/IP消息的总长度（包括头部）减8
- 即从Request ID字段开始到消息末尾的字节数

**请求ID(Request ID) - 32位**
由Client ID和Session ID组成：
- **客户端ID(Client ID) - 16位**: 标识发送请求的客户端
- **会话ID(Session ID) - 16位**: 用于匹配请求和响应

**协议版本(Protocol Version) - 8位**
- SOME/IP协议版本号，当前为0x01

**接口版本(Interface Version) - 8位**
- 服务接口的版本号

**消息类型(Message Type) - 8位**
- 0x00: REQUEST（请求）
- 0x01: REQUEST_NO_RETURN（无返回请求）
- 0x02: NOTIFICATION（通知/事件）
- 0x80: RESPONSE（响应）
- 0x81: ERROR（错误响应）

**返回码(Return Code) - 8位**
- 0x00: E_OK（成功）
- 0x01: E_NOT_OK（通用错误）
- 0x02: E_UNKNOWN_SERVICE（未知服务）
- 0x03: E_UNKNOWN_METHOD（未知方法）
- 0x04: E_NOT_READY（服务未准备）
- 0x05: E_NOT_REACHABLE（服务不可达）
- 0x06: E_TIMEOUT（超时）
- 0x07: E_WRONG_PROTOCOL_VERSION（协议版本错误）
- 0x08: E_WRONG_INTERFACE_VERSION（接口版本错误）
- 0x09: E_MALFORMED_MESSAGE（消息格式错误）
- 0x0A: E_WRONG_MESSAGE_TYPE（消息类型错误）

**载荷(Payload) - 可变长度**
- 具体的服务数据，长度由Length字段确定

### 在汽车以太网帧中的完整结构：

```
[以太网头部][IP头部][UDP/TCP头部][SOME/IP头部][SOME/IP载荷][以太网尾部]
```

典型层次结构：
```
+-------------------+
| 以太网头部(14字节)  |
+-------------------+
| IPv4头部(20字节)   |  或 IPv6头部(40字节)
+-------------------+
| UDP头部(8字节)     |  或 TCP头部(20+字节)
+-------------------+
| SOME/IP头部(16字节)|
+-------------------+
| SOME/IP载荷       |
+-------------------+
| 以太网尾部(4字节)  |
+-------------------+
```

### SOME/IP-SD (Service Discovery) 扩展格式：

SOME/IP-SD使用SOME/IP作为传输协议，Service ID固定为0xFFFF，Method ID为0x8100。

#### SD消息载荷格式：
```
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|     Flags     |   Reserved    |         Length of Entries    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                         Entries Array                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                      Length of Options                       |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                         Options Array                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

### SOME/IP消息类型示例：

#### 1. 方法调用请求：
```
Service ID: 0x1234       // 目标服务
Method ID: 0x0001        // 调用的方法
Message Type: 0x00       // REQUEST
Return Code: 0x00        // 请求中为0
```

#### 2. 方法调用响应：
```
Service ID: 0x1234       // 响应的服务
Method ID: 0x0001        // 对应的方法
Message Type: 0x80       // RESPONSE
Return Code: 0x00        // E_OK或错误码
```

#### 3. 事件通知：
```
Service ID: 0x1234       // 事件源服务
Method ID: 0x8001        // 事件ID（最高位为1）
Message Type: 0x02       // NOTIFICATION
Return Code: 0x00        // 通知中为0
```

### SOME/IP传输特点：

**优势：**
- **面向服务**: 支持RPC、事件和字段访问
- **高效序列化**: 支持多种数据类型的序列化
- **服务发现**: 通过SOME/IP-SD实现动态服务发现
- **灵活传输**: 可基于UDP或TCP传输
- **版本管理**: 支持接口版本控制

**应用场景：**
- **车载信息娱乐系统**
- **高级驾驶辅助系统(ADAS)**
- **车身控制系统**
- **动力系统控制**
- **网关和诊断系统**

SOME/IP协议作为AUTOSAR架构中的重要组成部分，为汽车电子系统提供了标准化的服务导向通信机制，支持现代汽车复杂的分布式软件架构需求。

## 6. 汽车以太网SOME/IP-SD协议报文格式

汽车以太网中SOME/IP-SD协议的报文格式如下：

### SOME/IP-SD报文整体结构

SOME/IP-SD基于SOME/IP协议，使用固定的Service ID和Method ID：

```
[SOME/IP头部(16字节)][SOME/IP-SD载荷]
```

#### SOME/IP头部中的固定值：
- **Service ID**: 0xFFFF0000 (SOME/IP-SD服务)
- **Method ID**: 0x00008100 (SD方法)
- **Message Type**: 0x02 (NOTIFICATION)

### SOME/IP-SD载荷格式

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|     Flags     |   Reserved    |        Length of Entries     |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
|                         Entries Array                        |
|                        (variable length)                     |
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                      Length of Options                       |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
|                         Options Array                        |
|                        (variable length)                     |
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

### SD载荷头部字段详细说明：

**标志位(Flags) - 8位**
```
 0 1 2 3 4 5 6 7
+-+-+-+-+-+-+-+-+
|R|U|M|R|R|R|R|R|
+-+-+-+-+-+-+-+-+
```
- **R**: Reboot Flag - 重启标志，设备重启后第一个SD消息设置为1
- **U**: Unicast Flag - 单播标志，当前未使用
- **M**: Multicast Flag - 组播标志，当前未使用
- 其余位保留，设置为0

**保留字段(Reserved) - 8位**
- 必须设置为0x00

**条目长度(Length of Entries) - 32位**
- Entries Array的总字节长度

**选项长度(Length of Options) - 32位**
- Options Array的总字节长度

### Entries Array格式

每个Entry的通用格式（12或16字节）：

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|      Type     |   Index 1st   |   Index 2nd   | # of Opts 1  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| # of Opts 2   |             Service ID                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|   Instance ID                 |    Major Ver  |     TTL       |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                          Minor Version                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

#### Entry类型和字段说明：

**类型(Type) - 8位**
- 0x00: Find Service Entry
- 0x01: Offer Service Entry  
- 0x06: Subscribe Eventgroup Entry
- 0x07: Subscribe Eventgroup Ack Entry
- 0x08: Subscribe Eventgroup Nack Entry

**索引字段 - 各8位**
- **Index 1st Options**: 指向第一个相关选项的索引
- **Index 2nd Options**: 指向第二个相关选项的索引（如果有）
- **# of Options 1**: 第一组选项的数量
- **# of Options 2**: 第二组选项的数量

**服务标识 - 16位**
- **Service ID**: 服务标识符

**实例标识 - 16位**
- **Instance ID**: 服务实例标识符

**版本信息**
- **Major Version - 8位**: 主版本号
- **Minor Version - 32位**: 次版本号

**生存时间(TTL) - 24位**
- 条目的有效时间，以秒为单位
- 0x000000表示停止提供服务
- 0xFFFFFF表示永不过期

### Options Array格式

每个Option的通用头部：

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|            Length             |      Type     |   Reserved    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                         Option Data                          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

#### 常见Option类型：

**1. IPv4 Endpoint Option (Type: 0x04)**
```
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|         Length = 0x0009       |     Type = 0x04     |Reserved|
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        IPv4 Address                          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|   Reserved    |    Protocol   |            Port               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

**2. IPv6 Endpoint Option (Type: 0x06)**
```
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|         Length = 0x0015       |     Type = 0x06     |Reserved|
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
+                        IPv6 Address                          +
|                        (128 bits)                            |
+                                                               +
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|   Reserved    |    Protocol   |            Port               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

**3. Configuration Option (Type: 0x01)**
```
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|            Length             |     Type = 0x01     |Reserved|
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Configuration String                      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

**4. Load Balancing Option (Type: 0x02)**
```
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|         Length = 0x0005       |     Type = 0x02     |Reserved|
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|          Priority             |            Weight             |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

### 典型SD消息示例：

#### 1. Offer Service消息：
```
Type: 0x01 (Offer Service)
Service ID: 0x1234
Instance ID: 0x0001  
Major Version: 0x01
Minor Version: 0x00000001
TTL: 0x000003 (3秒)
+ IPv4 Endpoint Option (IP: 192.168.1.100, Port: 3000, Protocol: UDP)
```

#### 2. Find Service消息：
```
Type: 0x00 (Find Service)
Service ID: 0x1234
Instance ID: 0xFFFF (任意实例)
Major Version: 0x01
Minor Version: 0xFFFFFFFF (任意次版本)
TTL: 0xFFFFFF
```

#### 3. Subscribe Eventgroup消息：
```
Type: 0x06 (Subscribe Eventgroup)
Service ID: 0x1234
Instance ID: 0x0001
Major Version: 0x01
Eventgroup ID: 0x0001 (在Minor Version字段中)
TTL: 0x00003C (60秒)
+ IPv4 Endpoint Option (订阅者地址)
```

### 在汽车以太网中的传输：

SOME/IP-SD通常使用UDP组播传输：
- **组播地址**: IPv4: 224.244.224.245, IPv6: FF02::1
- **端口**: 30490
- **传输周期**: 可配置，典型值为100ms-10s

SOME/IP-SD协议实现了汽车网络中服务的动态发现、发布和订阅机制，是现代汽车SOA架构的重要组成部分。

## 7. 汽车以太网DoIP诊断协议报文格式

汽车以太网中DoIP诊断协议的报文格式如下：

### DoIP通用报文头部格式（8字节）

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|    Protocol Version   |Inverse Protocol Version|  Payload Type |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        Payload Length                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                            Payload                           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

### DoIP头部字段详细说明：

**协议版本(Protocol Version) - 8位**
- 当前版本：0x02 (ISO 13400-2:2019)
- 早期版本：0x01 (ISO 13400-2:2012)

**反向协议版本(Inverse Protocol Version) - 8位**
- 协议版本的按位取反值
- 版本0x02对应：0xFD
- 用于验证报文完整性

**载荷类型(Payload Type) - 16位**
- 标识DoIP消息的具体类型

**载荷长度(Payload Length) - 32位**
- 载荷数据的字节长度（不包括8字节头部）

### DoIP载荷类型定义：

#### 车辆识别和公告消息：
- **0x0000**: Generic DoIP header negative acknowledge
- **0x0001**: Vehicle identification request message
- **0x0002**: Vehicle identification request message with EID
- **0x0003**: Vehicle identification request message with VIN
- **0x0004**: Vehicle announcement message / Vehicle identification response

#### 路由激活消息：
- **0x0005**: Routing activation request
- **0x0006**: Routing activation response

#### 诊断消息：
- **0x8001**: Diagnostic message
- **0x8002**: Diagnostic message positive acknowledgement
- **0x8003**: Diagnostic message negative acknowledgement

#### 控制消息：
- **0x4001**: DoIP entity status request
- **0x4002**: DoIP entity status response
- **0x4003**: Diagnostic power mode information request
- **0x4004**: Diagnostic power mode information response

### 主要DoIP消息格式：

#### 1. 车辆公告消息 (Payload Type: 0x0004)

```
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                            VIN                                |
|                        (17 bytes)                            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|            Logical Address            |                       |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                       +
|                            EID                                |
|                        (6 bytes)                             |
+                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                               |                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               +
|                            GID                                |
|                        (6 bytes)                             |
+                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                               |Further Action Required|
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        VIN/GID Sync Status                   |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

字段说明：
- **VIN**: Vehicle Identification Number (车辆识别号)
- **Logical Address**: DoIP实体的逻辑地址
- **EID**: Entity Identification (实体标识符，通常为MAC地址)
- **GID**: Group Identification (组标识符)
- **Further Action Required**: 进一步操作要求
- **VIN/GID Sync Status**: VIN/GID同步状态

#### 2. 路由激活请求 (Payload Type: 0x0005)

```
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|        Source Address         |     Activation Type   |Reserved|
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        Reserved                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        OEM Specific                          |
|                        (optional)                            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

字段说明：
- **Source Address**: 外部测试设备的逻辑地址
- **Activation Type**: 激活类型
  - 0x00: Default
  - 0x01: WWH-OBD vehicle discovery
  - 0xE0: Central security

#### 3. 路由激活响应 (Payload Type: 0x0006)

```
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|      Logical Address of       |     Activation Type   |Reserved|
|      DoIP Entity              |                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        Reserved                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|     Response Code     |                Reserved               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        OEM Specific                          |
|                        (optional)                            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

响应码定义：
- **0x00**: Unknown source address
- **0x01**: All sockets and/or activation type supported
- **0x02**: Socket successfully registered and activated
- **0x03**: Registered source address, but invalid activation type
- **0x04**: Socket successfully registered but activation denied
- **0x05**: Invalid source address
- **0x06**: Unsupported activation type
- **0x07**: TLS connection required
- **0x08**: Rejected confirmation required

#### 4. 诊断消息 (Payload Type: 0x8001)

```
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|        Source Address         |        Target Address        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        User Data                              |
|                     (UDS Message)                            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

字段说明：
- **Source Address**: 源逻辑地址（测试设备）
- **Target Address**: 目标逻辑地址（ECU）
- **User Data**: UDS诊断消息内容

#### 5. 诊断消息确认 (Payload Type: 0x8002/0x8003)

正面确认 (0x8002)：
```
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|        Source Address         |        Target Address        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|     ACK Code  |                Previous Message Data         |
+-+-+-+-+-+-+-+-+                                               +
|                        (optional)                            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

负面确认 (0x8003)：
```
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|        Source Address         |        Target Address        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|     NACK Code |                Previous Message Data         |
+-+-+-+-+-+-+-+-+                                               +
|                        (optional)                            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

NACK码定义：
- **0x00**: Generic DoIP header negative acknowledge
- **0x01**: Invalid source address
- **0x02**: Unknown target address
- **0x03**: Diagnostic message too large
- **0x04**: Out of memory
- **0x05**: Target unreachable
- **0x06**: Unknown network
- **0x07**: Transport protocol error

### DoIP在汽车以太网中的传输：

#### TCP连接（诊断通信）：
- **端口**: 13400
- **连接方式**: 客户端（测试设备）连接服务器（DoIP网关）
- **用途**: 诊断消息传输

#### UDP广播（车辆发现）：
- **端口**: 13400
- **用途**: 车辆识别和公告

#### 完整协议栈：
```
+-------------------+
| 以太网头部(14字节)  |
+-------------------+
| IP头部(20/40字节)  |
+-------------------+
| TCP/UDP头部       |
+-------------------+
| DoIP头部(8字节)    |
+-------------------+
| DoIP载荷          |
+-------------------+
| 以太网尾部(4字节)  |
+-------------------+
```

### DoIP诊断流程：

1. **车辆发现**: UDP广播车辆识别请求
2. **车辆公告**: 车辆响应识别请求
3. **建立连接**: TCP连接到DoIP网关
4. **路由激活**: 激活诊断路由
5. **诊断通信**: 发送UDS诊断消息
6. **路由去激活**: 关闭诊断会话

DoIP协议为现代汽车提供了基于IP网络的标准化诊断接口，支持远程诊断、OTA更新和车辆维护等应用场景。